---
title: "Machine Learning"
author: "Arfa Aijazi"
date: "October 2023"
output:
  html_document:
    df_print: paged
---

This script builds a machine learning model to predict temperature-related morbidity

### Setup
Load libraries
```{r echo=TRUE, message=FALSE, warning=FALSE}

# install.packages(c("zoo","xts","quantmod", "ROCR", "abind"))
# install.packages("DMwR_0.4.1.tar", repos=NULL, type="source") # Package DMwR removed from the CRAN repository, so was downloaded from the Archives (https://cran.r-project.org/src/contrib/Archive/DMwR/). This package contains the SMOTE function integrated into caret's cross validation. 

library(tidyverse)
library(caret)
library(caretEnsemble)
library(DMwR)
library(doParallel)


options(es.use_symbols = TRUE)
```

Import data
```{r}
recs_range <- read_csv("../data/recs_range.csv") %>%
  mutate(TEMPMA = ifelse(TEMPMA == 1, "TEMPMA", "NONE")) %>%
  mutate(TEMPMA = factor(TEMPMA))
```

### Machine learning model building
Partition data
```{r}
set.seed(3456)
trainIndex <- createDataPartition(recs_range$TEMPMA, p = 0.8, list = FALSE, times = 1)

trainData <- recs_range[trainIndex,]
testData <- recs_range[-trainIndex,]

X <- trainData %>% select(-TEMPMA)
Y <- trainData$TEMPMA
```

Hyperparameter tuning
```{r}
# Cross validate with adaptive resampling. This method resamples the hyperparamter combinations with values near combinations that performed well. It will divide the training data into k folds and repeat the process n times. 

k = 10
n = 10

set.seed(1234) 
adaptControl <- trainControl(method = "adaptive_cv",
                     number = k, repeats = n, 
                     adaptive = list(min = 3, alpha = 0.05, method = "gls", complete = TRUE),
                     classProbs = TRUE,
                     index = createFolds(trainData$TEMPMA, k), # ensures all models have the same folds
                     summaryFunction = twoClassSummary,
                     search = "random",
                     allowP
                     )
```

Parallel processing
```{r}
cl <- makePSOCKcluster(4, ) # 4 cores
registerDoParallel(cl)
```

```{r}
set.seed(150)
svmAdapt <- train(TEMPMA ~ ., data = trainData,
                  method = "svmRadial",
                  trControl = adaptControl,
                  metric = "ROC",
                  tuneLength = 25)
```

End parallel processing
```{r}
stopCluster(cl)
```

