---
title: "R Notebook"
output: html_notebook
---

Common parameters for parameter tuning
```{r}
# Cross validate with 10-fold cross validation with 5 repeats
k = 10
n = 5

set.seed(1234) 
ctrl <- trainControl(method = "repeatedcv",
                     number = k,
                     repeats = n, 
                     classProbs = TRUE,
                     index = createFolds(trainData$TEMPMA, k), # ensures all models have the same folds
                     summaryFunction = twoClassSummary
                     )
```





```{r}
# Number of hyperparameters to test
t = 25

# Set up tuning grids
ridge_grid <- expand.grid(alpha = 0, lambda = c(0, 10^seq(5, -5, length = t-1)))
lasso_grid <- expand.grid(alpha = 1, lambda = c(0, 10^seq(5, -5, length = t-1)))
svmLinear_grid <- expand.grid(C = 10^seq(-5, 5, length = t))
svmRadial_grid <- expand.grid(C = seq(0, 5, length = sqrt(t)), sigma = 2^seq(-3, 5, length = sqrt(t))) # rule of thumb that optimal k in knn is sqrt(n)
knn_grid <- expand.grid(k = round(seq(1, sqrt(nrow(trainData)), length = t))) %>% 
  mutate(k = ifelse((k %% 2) == 0, k+1, k)) # ensure knn has an odd number for k to prevent ties in classifying two classes
rf_grid <- expand.grid(mtry = seq(1, 25, length = t))
nn_grid <- expand.grid(size = seq(1, 20, length = sqrt(t)), decay = 10^seq(-7, -1, length = sqrt(t)))
```


Create a custom SMOTE function to use within resampling. The perc.over parameter was set to generate 9x more samples of the minority class (households with temperature-related morbidity). The percent.under parameter was set to retain all samples of the majority class (households without temperature-related morbidity). Overall this results in temperature-related morbidity accounting for around 10% of the training data vs 1% in the real data. 
```{r}
smote2 <- list(name = "SMOTE with custom parameters",
                func = function (x, y) {
                  library(DMwR)
                  dat <- if (is.data.frame(x)) x else as.data.frame(x)
                  dat$.y <- as.factor(y)
                  dat <- SMOTE(.y ~ ., 
                               data = dat, 
                               perc.over = 900,
                               perc.under = 1053,
                               k = 13)
                  list(x = dat[, !grepl(".y", colnames(dat), fixed = TRUE)], 
                       y = dat$.y)
                  },
                first = TRUE)
```

#### Baseline model
```{r}
models <- read_csv("../data/models.csv")
baseline <- models %>%
  filter(BASELINE == 1)

trainData_baseline <- trainData %>%
  select(starts_with(baseline$VARIABLE))

trainData_baseline$TEMPMA <- Y
```

Baseline model and no SMOTE
```{r include=FALSE}
ctrl$sampling <- NULL

# Compare multiple machine learning models
model_list_baseline_none <- caretList(TEMPMA ~ ., 
                        data = trainData_baseline, 
                        trControl = ctrl,
                        tuneList=list(
                          ridge = caretModelSpec(method = "glmnet", tuneGrid = ridge_grid),
                          lasso = caretModelSpec(method = "glmnet", tuneGrid = lasso_grid),
                          svmLinear = caretModelSpec(method = "svmLinear", tuneGrid = svmLinear_grid),
                          svmRadial = caretModelSpec(method = "svmRadial", tuneGrid = svmRadial_grid),
                          knn = caretModelSpec(method = "knn", tuneGrid = knn_grid),
                          rf = caretModelSpec(method = "rf", tuneGrid = rf_grid),
                          nn = caretModelSpec(method = "nnet", tuneGrid = nn_grid)
                        ))
save(model_list_baseline_none,file="baseline_none.Rda")


```

Baseline model and SMOTE
```{r include=FALSE}
# SMOTE
ctrl$sampling <- smote2

# Compare multiple machine learning models
model_list_baseline_smote <- caretList(TEMPMA ~ ., 
                        data = trainData_baseline, 
                        trControl = ctrl,
                        tuneList=list(
                          ridge = caretModelSpec(method = "glmnet", tuneGrid = ridge_grid),
                          lasso = caretModelSpec(method = "glmnet", tuneGrid = lasso_grid),
                          svmLinear = caretModelSpec(method = "svmLinear", tuneGrid = svmLinear_grid),
                          svmRadial = caretModelSpec(method = "svmRadial", tuneGrid = svmRadial_grid),
                          knn = caretModelSpec(method = "knn", tuneGrid = knn_grid),
                          rf = caretModelSpec(method = "rf", tuneGrid = rf_grid),
                          nn = caretModelSpec(method = "nnet", tuneGrid = nn_grid)
                        ))
save(model_list_baseline_smote,file="baseline_smote.Rda")
```

#### All features
Model with all features and no SMOTE
```{r include=FALSE}
# Compare multiple machine learning models
ctrl$sampling <- NULL

model_list_all_none <- caretList(TEMPMA ~ ., 
                        data = trainData, 
                        trControl = ctrl,
                        tuneList=list(
                          ridge = caretModelSpec(method = "glmnet", tuneGrid = ridge_grid),
                          svmLinear = caretModelSpec(method = "svmLinear", tuneGrid = svmLinear_grid),
                          svmRadial = caretModelSpec(method = "svmRadial", tuneGrid = svmRadial_grid),
                          knn = caretModelSpec(method = "knn", tuneGrid = knn_grid),
                          rf = caretModelSpec(method = "rf", tuneGrid = rf_grid),
                          nn = caretModelSpec(method = "nnet", tuneGrid = nn_grid)
                        ))

save(model_list_all_none,file="all_none.Rda")
```

Model with all features and SMOTE
```{r include=FALSE}
# SMOTE
ctrl$sampling <- smote2

# Compare multiple machine learning models
model_list_all_smote <- caretList(TEMPMA ~ ., 
                        data = trainData, 
                        trControl = ctrl,
                        tuneList=list(
                          ridge = caretModelSpec(method = "glmnet", tuneGrid = ridge_grid),
                          svmLinear = caretModelSpec(method = "svmLinear", tuneGrid = svmLinear_grid),
                          svmRadial = caretModelSpec(method = "svmRadial", tuneGrid = svmRadial_grid),
                          knn = caretModelSpec(method = "knn", tuneGrid = knn_grid),
                          rf = caretModelSpec(method = "rf", tuneGrid = rf_grid),
                          nn = caretModelSpec(method = "nnet", tuneGrid = nn_grid)
                        ))

save(model_list_all_smote,file="all_smote.Rda")
```

### Model performance
With training data
```{r}
results_baseline_none <- as.data.frame(resamples(model_list_baseline_none)) %>%
  mutate(Sampling = "None") %>%
  mutate(Model = "Baseline")

results_baseline_smote <- as.data.frame(resamples(model_list_baseline_smote)) %>%
  mutate(Sampling = "SMOTE") %>%
  mutate(Model = "Baseline")

results_all_none <- as.data.frame(resamples(model_list_all_none)) %>%
  mutate(Sampling = "None") %>%
  mutate(Model = "All")

results_all_smote <- as.data.frame(resamples(model_list_all_smote)) %>%
  mutate(Sampling = "SMOTE") %>%
  mutate(Model = "All")
```




